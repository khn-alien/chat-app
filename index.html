<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messenger Clone</title>
    <style>
        /* Simplified CSS for troubleshooting */
        body { margin: 0; font-family: Arial; }
        #authScreen { display: flex; justify-content: center; padding: 20px; }
        #app { display: none; }
        .user-item { padding: 10px; border-bottom: 1px solid #ddd; }
        .chat-messages { height: 70vh; overflow-y: auto; padding: 20px; }
        .message { margin: 10px; padding: 10px; background: #e9ecef; border-radius: 10px; }
        .sent { background: #0084ff; color: white; margin-left: auto; }
    </style>
</head>
<body>
    <div id="authScreen">
        <div>
            <h2>Login</h2>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button onclick="handleAuth()">Login</button>
            <button onclick="toggleAuthMode()">Switch to Signup</button>
            <div id="authError" style="color: red;"></div>
        </div>
    </div>

    <div id="app">
        <div style="width: 300px; border-right: 1px solid #ddd;">
            <h3>Users</h3>
            <div id="userList"></div>
        </div>
        <div style="flex: 1;">
            <div id="chatMessages" class="chat-messages"></div>
            <div>
                <input type="text" id="messageInput" placeholder="Type message...">
                <input type="file" id="fileInput">
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <script>
        // Debugging version with logs
        console.log('Initializing Firebase...');
        
        const firebaseConfig = {
            apiKey: "AIzaSyA9KPmQOZtSvFv4OI05AxYYpzDwUT1A7nA",
            authDomain: "khn-chat.firebaseapp.com",
            projectId: "khn-chat",
            storageBucket: "khn-chat.appspot.com",
            messagingSenderId: "127670303843",
            appId: "1:127670303843:web:3e3009ed10712e432c4c56",
            measurementId: "G-MDQQEMCZLR"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const storage = firebase.storage();
        let currentUser = null;
        let selectedUserId = null;
        let isSignUp = false;

        // 1. Check Authentication Flow
        auth.onAuthStateChanged(user => {
            console.log('Auth state changed:', user);
            if (user) {
                currentUser = user;
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                setupPresence();
                loadUsers();
            } else {
                console.log('No user logged in');
            }
        });

        async function handleAuth() {
            console.log('Auth button clicked');
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                if (isSignUp) {
                    console.log('Attempting signup');
                    await auth.createUserWithEmailAndPassword(email, password);
                    await db.ref(`users/${auth.currentUser.uid}`).set({
                        email: email,
                        displayName: email.split('@')[0],
                        online: true
                    });
                } else {
                    console.log('Attempting login');
                    await auth.signInWithEmailAndPassword(email, password);
                }
            } catch (error) {
                console.error('Auth error:', error);
                document.getElementById('authError').textContent = error.message;
            }
        }

        // 2. Check Presence System
        function setupPresence() {
            console.log('Setting up presence');
            const userStatusRef = db.ref(`status/${currentUser.uid}`);
            const isOffline = { online: false, lastActive: firebase.database.ServerValue.TIMESTAMP };
            
            db.ref('.info/connected').on('value', (snapshot) => {
                if (snapshot.val()) {
                    userStatusRef.onDisconnect().set(isOffline).then(() => {
                        userStatusRef.set({ online: true, lastActive: firebase.database.ServerValue.TIMESTAMP });
                    });
                }
            });
        }

        // 3. Check User List Loading
        function loadUsers() {
            console.log('Loading users');
            db.ref('users').on('value', (snapshot) => {
                const users = snapshot.val() || {};
                console.log('Users data:', users);
                
                const userList = document.getElementById('userList');
                userList.innerHTML = '';
                
                Object.entries(users).forEach(([uid, user]) => {
                    if (uid !== currentUser.uid) {
                        const div = document.createElement('div');
                        div.className = 'user-item';
                        div.textContent = user.displayName + (user.online ? ' (online)' : ' (offline)');
                        div.onclick = () => startChat(uid);
                        userList.appendChild(div);
                    }
                });
            });
        }

        // 4. Check Chat Functionality
        async function startChat(partnerId) {
            console.log('Starting chat with:', partnerId);
            selectedUserId = partnerId;
            const chatId = [currentUser.uid, partnerId].sort().join('_');
            
            db.ref(`chats/${chatId}/messages`).on('child_added', (snapshot) => {
                const message = snapshot.val();
                console.log('New message:', message);
                displayMessage(message);
            });
        }

        async function sendMessage() {
            console.log('Sending message');
            const message = {
                text: document.getElementById('messageInput').value,
                sender: currentUser.uid,
                timestamp: Date.now()
            };
            
            const chatId = [currentUser.uid, selectedUserId].sort().join('_');
            await db.ref(`chats/${chatId}/messages`).push(message);
            document.getElementById('messageInput').value = '';
        }

        function displayMessage(message) {
            const div = document.createElement('div');
            div.className = `message ${message.sender === currentUser.uid ? 'sent' : ''}`;
            div.textContent = message.text;
            document.getElementById('chatMessages').appendChild(div);
        }

        // 5. Toggle auth mode
        function toggleAuthMode() {
            isSignUp = !isSignUp;
            document.getElementById('authError').textContent = '';
            document.querySelector('button').textContent = isSignUp ? 'Sign Up' : 'Login';
        }

        console.log('Initialization complete');
    </script>
</body>
</html>
