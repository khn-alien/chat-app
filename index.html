<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Firebase React Chat App</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Firebase SDK v9 Compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-100 h-screen flex items-center justify-center">
  <div id="root" class="w-full h-full"></div>
  <script type="text/babel">
    const firebaseConfig = {
      apiKey: "AIzaSyA9KPmQOZtSvFv4OI05AxYYpzDwUT1A7nA",
      authDomain: "khn-chat.firebaseapp.com",
      databaseURL: "https://khn-chat-default-rtdb.firebaseio.com",
      projectId: "khn-chat",
      storageBucket: "khn-chat.firebasestorage.app",
      messagingSenderId: "127670303843",
      appId: "1:127670303843:web:3e3009ed10712e432c4c56",
      measurementId: "G-MDQQEMCZLR"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const { useState, useEffect } = React;

    function App() {
      const [user, setUser] = useState(null);

      useEffect(() => {
        auth.onAuthStateChanged((u) => {
          setUser(u);
          if (u) {
            const userStatusRef = db.ref(`/status/${u.uid}`);
            db.ref(".info/connected").on("value", (snap) => {
              if (snap.val() === true) {
                userStatusRef.onDisconnect().set({ state: 'offline', last_changed: firebase.database.ServerValue.TIMESTAMP });
                userStatusRef.set({ state: 'online', last_changed: firebase.database.ServerValue.TIMESTAMP });
              }
            });
          }
        });
      }, []);

      if (!user) return <Login />;
      return <ChatInterface user={user} />;
    }

    function Login() {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');

      const handleLogin = async () => {
        try {
          await auth.signInWithEmailAndPassword(email, password);
        } catch (e) {
          setError(e.message);
        }
      };

      const handleSignup = async () => {
        try {
          await auth.createUserWithEmailAndPassword(email, password);
        } catch (e) {
          setError(e.message);
        }
      };

      return (
        <div className="max-w-sm mx-auto bg-white p-6 rounded shadow">
          <h2 className="text-2xl mb-4">Login / Sign Up</h2>
          {error && <p className="text-red-500 mb-2">{error}</p>}
          <input value={email} onChange={e => setEmail(e.target.value)} placeholder="Email" className="w-full mb-2 p-2 border rounded" />
          <input value={password} onChange={e => setPassword(e.target.value)} type="password" placeholder="Password" className="w-full mb-4 p-2 border rounded" />
          <button onClick={handleLogin} className="w-full bg-blue-500 text-white p-2 rounded mb-2">Login</button>
          <button onClick={handleSignup} className="w-full bg-green-500 text-white p-2 rounded">Sign Up</button>
        </div>
      );
    }

    function ChatInterface({ user }) {
      return (
        <div className="flex h-full items-center justify-center">
          <p className="text-lg">Welcome, {user.email}</p>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>
