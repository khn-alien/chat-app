<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Previous CSS remains the same -->
    <style>
        /* All previous CSS styles remain unchanged */
    </style>
</head>
<body>
    <!-- HTML structure remains the same -->
    <div id="app">
        <!-- Same HTML as before -->
    </div>

    <script>
        // Firebase configuration with your credentials
        const firebaseConfig = {
            apiKey: "AIzaSyA9KPmQOZtSvFv4OI05AxYYpzDwUT1A7nA",
            authDomain: "khn-chat.firebaseapp.com",
            projectId: "khn-chat",
            storageBucket: "khn-chat.appspot.com",
            messagingSenderId: "127670303843",
            appId: "1:127670303843:web:3e3009ed10712e432c4c56",
            measurementId: "G-MDQQEMCZLR"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const storage = firebase.storage();

        // Fixed and enhanced features below
        let currentUser = null;
        let messagesRef = db.ref('messages');
        let typingRef = db.ref('typing');
        let usersRef = db.ref('users');
        let userStatusRef = db.ref('.info/connected');

        // Enhanced auth state handler
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                initChat();
                trackUserPresence();
                setupTypingListener();
            } else {
                showAuthSection();
                cleanupPresence();
            }
        });

        // Fixed presence tracking
        function trackUserPresence() {
            const userRef = usersRef.child(currentUser.uid);
            
            userStatusRef.on('value', (snapshot) => {
                if (snapshot.val() === true) {
                    userRef.onDisconnect().update({
                        online: false,
                        lastActive: firebase.database.ServerValue.TIMESTAMP
                    }).then(() => {
                        userRef.update({
                            uid: currentUser.uid,
                            email: currentUser.email,
                            online: true,
                            lastActive: firebase.database.ServerValue.TIMESTAMP
                        });
                    });
                }
            });
        }

        // Fixed message deletion
        async function deleteMessage(messageId) {
            if (confirm('Delete this message?')) {
                try {
                    const messageRef = messagesRef.child(messageId);
                    const message = (await messageRef.once('value')).val();
                    
                    if (message.imageUrl) {
                        const storageRef = storage.refFromURL(message.imageUrl);
                        await storageRef.delete();
                    }
                    
                    await messageRef.remove();
                } catch (error) {
                    showError('Failed to delete message: ' + error.message);
                }
            }
        }

        // Fixed file upload with progress
        async function uploadFile(file) {
            const sendBtn = document.getElementById('send-btn');
            try {
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<div class="loading"></div>Uploading...';

                const storageRef = storage.ref(`messages/${currentUser.uid}/${Date.now()}_${file.name}`);
                const uploadTask = storageRef.put(file);

                // Add progress listener
                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        sendBtn.innerHTML = `<div class="loading"></div>Uploading ${Math.round(progress)}%`;
                    },
                    (error) => {
                        throw error;
                    },
                    async () => {
                        const url = await uploadTask.snapshot.ref.getDownloadURL();
                        await messagesRef.push({
                            imageUrl: url,
                            sender: currentUser.email,
                            timestamp: Date.now()
                        });
                    }
                );
            } catch (error) {
                showError('Upload failed: ' + error.message);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send';
            }
        }

        // Enhanced typing indicator
        function setupTypingListener() {
            let isTyping = false;
            let lastTypingTime = 0;
            const typingTimeout = 3000; // 3 seconds

            document.getElementById('message-input').addEventListener('input', () => {
                const now = Date.now();
                if (!isTyping || now - lastTypingTime > typingTimeout) {
                    typingRef.child(currentUser.uid).set(true);
                    isTyping = true;
                }
                lastTypingTime = now;

                setTimeout(() => {
                    if (Date.now() - lastTypingTime > typingTimeout) {
                        typingRef.child(currentUser.uid).set(false);
                        isTyping = false;
                    }
                }, typingTimeout);
            });

            // Handle window blur
            window.addEventListener('blur', () => {
                typingRef.child(currentUser.uid).set(false);
            });
        }

        // Fixed online users display
        function setupPresenceListener() {
            usersRef.orderByChild('online').equalTo(true).on('value', (snapshot) => {
                const onlineUsers = [];
                snapshot.forEach((childSnapshot) => {
                    const user = childSnapshot.val();
                    if (user.uid !== currentUser.uid) {
                        onlineUsers.push(user.email.split('@')[0]);
                    }
                });
                updateOnlineUsers(onlineUsers);
            });
        }

        // Rest of the code remains the same as previous version
        // ... (include all other functions from previous version)
    </script>
</body>
</html>
