<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Realtime Chat App</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f6f9;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    #app {
      max-width: 650px;
      width: 100%;
      background: #fff;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      height: 80vh;
    }

    h2 {
      text-align: center;
      color: #333;
      margin: 0 0 1rem;
    }

    #messages {
      height: 400px;
      overflow-y: auto;
      background: #f0f2f5;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .msg {
      padding: 10px;
      border-radius: 8px;
      max-width: 80%;
      word-wrap: break-word;
      position: relative;
    }

    .me {
      background: #0078d4;
      color: white;
      align-self: flex-end;
    }

    .other {
      background: #e9ecef;
      color: #333;
      align-self: flex-start;
    }

    .timestamp {
      font-size: 0.7rem;
      color: rgba(255, 255, 255, 0.8);
      margin-top: 5px;
    }

    .other .timestamp {
      color: rgba(0, 0, 0, 0.6);
    }

    .typing {
      font-size: 0.8rem;
      color: #6c757d;
      font-style: italic;
      margin: 5px 0;
    }

    .input-container {
      display: flex;
      gap: 10px;
      padding: 10px;
      border-top: 1px solid #dee2e6;
      background: #fff;
    }

    input {
      flex: 1;
      padding: 12px;
      border-radius: 20px;
      border: 1px solid #dee2e6;
      font-size: 1rem;
    }

    button, .file-label {
      background: #0078d4;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    button:hover, .file-label:hover {
      background: #0056b3;
    }

    .file-input {
      display: none;
    }

    .image-container {
      position: relative;
      background: #f0f0f0;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 5px;
    }

    .image-loading {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.8);
      color: #666;
      font-size: 0.9rem;
    }

    img {
      max-width: 100%;
      height: auto;
      display: block;
    }

    .auto-scroll-anchor {
      float: left;
      height: 1px;
      visibility: hidden;
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="loginSection">
      <h2>Login</h2>
      <input id="email" type="email" placeholder="Email" required>
      <input id="password" type="password" placeholder="Password" required>
      <button onclick="login()">Login</button>
      <p id="loginStatus" style="color: red; font-size: 0.9rem;"></p>
    </div>

    <div id="chatSection" style="display:none;">
      <h2>Chat Room</h2>
      <div id="messages"></div>
      <div id="typingIndicator" class="typing"></div>
      <div class="input-container">
        <label class="file-label">
          ðŸ“Ž
          <input type="file" id="fileInput" class="file-input" accept="image/*">
        </label>
        <input id="msgInput" type="text" placeholder="Type a message...">
        <button onclick="sendMessage()">Send</button>
      </div>
      <div style="display: flex; gap: 10px; margin-top: 1rem;">
        <button onclick="logout()">Logout</button>
        <button onclick="clearChat()" style="background: #dc3545;">Clear Chat</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA9KPmQOZtSvFv4OI05AxYYpzDwUT1A7nA",
      authDomain: "khn-chat.firebaseapp.com",
      projectId: "khn-chat",
      storageBucket: "khn-chat.appspot.com",
      messagingSenderId: "127670303843",
      appId: "1:127670303843:web:3e3009ed10712e432c4c56",
      measurementId: "G-MDQQEMCZLR"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();

    let currentUser = null;
    let messageListener = null;
    let typingListener = null;
    const typingRef = db.ref('typing');
    const messagesRef = db.ref('messages');
    let autoScroll = true;

    const throttle = (func, limit) => {
      let lastFunc;
      let lastRan;
      return function() {
        const context = this;
        const args = arguments;
        if (!lastRan) {
          func.apply(context, args);
          lastRan = Date.now();
        } else {
          clearTimeout(lastFunc);
          lastFunc = setTimeout(() => {
            if ((Date.now() - lastRan) >= limit) {
              func.apply(context, args);
              lastRan = Date.now();
            }
          }, limit - (Date.now() - lastRan));
        }
      }
    };

    const escapeHtml = (text) => {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    };

    async function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        currentUser = userCredential.user;
        initChat();
      } catch (error) {
        document.getElementById('loginStatus').textContent = error.message;
      }
    }

    function initChat() {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('chatSection').style.display = 'block';
      setupMessageListener();
      setupTypingListener();
      setupEventListeners();
      scrollToBottom();
    }

    function setupMessageListener() {
      if (messageListener) messagesRef.off('child_added', messageListener);
      
      messageListener = messagesRef.on('child_added', snapshot => {
        const data = snapshot.val();
        const div = document.createElement('div');
        div.className = `msg ${data.sender === currentUser.email ? 'me' : 'other'}`;
        
        let content = `
          <div><strong>${escapeHtml(data.sender)}</strong></div>
          ${data.text ? `<div>${escapeHtml(data.text)}</div>` : ''}
          ${data.imageUrl ? `
            <div class="image-container">
              <img src="${data.imageUrl}" alt="Uploaded image" 
                   onload="this.parentElement.style.backgroundImage = 'none'">
              <div class="image-loading">Loading image...</div>
            </div>
          ` : ''}
          <div class="timestamp">${new Date(data.timestamp).toLocaleTimeString()}</div>
          <div class="auto-scroll-anchor"></div>
        `;
        
        div.innerHTML = content;
        const messagesDiv = document.getElementById('messages');
        messagesDiv.appendChild(div);

        if (autoScroll) {
          requestAnimationFrame(() => {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
          });
        }

        const img = div.querySelector('img');
        if (img) {
          img.onload = () => {
            if (autoScroll) {
              messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
          };
        }
      });

      const messagesDiv = document.getElementById('messages');
      messagesDiv.addEventListener('scroll', () => {
        const threshold = 100;
        const atBottom = messagesDiv.scrollHeight - messagesDiv.scrollTop <= messagesDiv.clientHeight + threshold;
        autoScroll = atBottom;
      });
    }

    function setupTypingListener() {
      if (typingListener) typingRef.off('value', typingListener);
      
      typingListener = typingRef.on('value', snapshot => {
        const typingUsers = Object.entries(snapshot.val() || {})
          .filter(([uid, isTyping]) => uid !== currentUser?.uid && isTyping)
          .map(([uid]) => uid);

        const indicator = document.getElementById('typingIndicator');
        indicator.textContent = typingUsers.length > 0 ? 
          `${typingUsers.length} user${typingUsers.length > 1 ? 's' : ''} typing...` : '';
      });
    }

    function setupEventListeners() {
      const msgInput = document.getElementById('msgInput');
      const fileInput = document.getElementById('fileInput');
      
      msgInput.addEventListener('input', throttle(() => {
        typingRef.child(currentUser.uid).set(msgInput.value.trim().length > 0);
      }, 300));

      msgInput.addEventListener('keypress', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      fileInput.addEventListener('change', uploadImage);
      
      window.addEventListener('beforeunload', () => {
        typingRef.child(currentUser.uid).set(false);
      });
    }

    async function sendMessage() {
      const msgInput = document.getElementById('msgInput');
      const text = msgInput.value.trim();
      if (!text) return;

      try {
        await messagesRef.push({
          text: text,
          sender: currentUser.email,
          timestamp: Date.now(),
          imageUrl: ''
        });
        
        msgInput.value = '';
        typingRef.child(currentUser.uid).set(false);
      } catch (error) {
        console.error('Error sending message:', error);
      }
    }

    async function uploadImage() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) return;

      try {
        // Generate unique filename
        const filename = `${Date.now()}_${file.name.replace(/\s+/g, '_')}`;
        const storageRef = storage.ref(`images/${filename}`);
        
        // Upload file
        const snapshot = await storageRef.put(file);
        
        // Get download URL
        const url = await snapshot.ref.getDownloadURL();

        // Create message with image
        await messagesRef.push({
          sender: currentUser.email,
          timestamp: Date.now(),
          text: '',
          imageUrl: url
        });

        // Reset file input
        document.getElementById('fileInput').value = '';
      } catch (error) {
        console.error('Upload failed:', error);
        alert(`Image upload failed: ${error.message}`);
      }
    }

    function clearChat() {
      if (confirm('Are you sure you want to clear all messages?')) {
        messagesRef.remove();
      }
    }

    function logout() {
      auth.signOut();
      location.reload();
    }

    function scrollToBottom() {
      const messagesDiv = document.getElementById('messages');
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        initChat();
      } else {
        currentUser = null;
        document.getElementById('loginSection').style.display = 'block';
        document.getElementById('chatSection').style.display = 'none';
      }
    });
  </script>
</body>
</html>
